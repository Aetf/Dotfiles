[Unit]
Description=Unload brcmfmac kernel module when suspend and load it upon resume
Before=sleep.target
StopWhenUnneeded=yes

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/bin/rmmod brcmfmac
ExecStop=/usr/bin/sh -c 'modprobe brcmfmac; udevadm test /sys/devices/pci0000:00/0000:00:1c.2/0000:03:00.0'

[Install]
WantedBy=sleep.target
