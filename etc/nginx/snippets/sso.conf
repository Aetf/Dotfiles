# Protect the server using the auth_request
auth_request /sso-auth;
# auth_request will reply 401 if /sso-auth proxy replies 401
# we use this to redirect the user back to the login page by
# serving a special location block @error401 defined below
error_page 401 = @error401;

## Optionally set a header to pass through the username
#auth_request_set $username $upstream_http_x_username;
#proxy_set_header X-User $username;

# Automatically renew SSO cookie on request
auth_request_set $cookie $upstream_http_set_cookie;
add_header Set-Cookie $cookie;

location /sso-auth {
    # make sure no infinite loop
    #auth_request off;
    # Do not allow requests from outside
    internal;
    # Access /auth endpoint to query login state
    proxy_pass http://127.0.0.1:8082/auth;
    # Do not forward the request body (nginx-sso does not care about it)
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    # Set custom information for ACL matching: Each one is available as
    # a field for matching: X-Host = x-host, ...
    proxy_set_header X-Origin-URI $request_uri;
    proxy_set_header X-Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location @error401 {
    # make sure no infinite loop
    #auth_request off;
    # Another server{} directive also proxying to http://127.0.0.1:8082
    return 302 https://login.unlimited-code.works/login?go=$scheme://$http_host$request_uri;
}

# If the user is lead to /logout redirect them to the logout endpoint
# of ngninx-sso which then will redirect the user to / on the current host
location /sso-logout {
    # make sure no infinite loop
    #auth_request off;
    # Another server{} directive also proxying to http://127.0.0.1:8082
    return 302 https://login.unlimited-code.works/logout?go=$scheme://$http_host/;
}

